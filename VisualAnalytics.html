<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Analytics</title>
    <!--panel libraries for ui-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.2.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.2.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@holoviz/panel@0.13.0/dist/panel.min.js"></script>
    <script type="text/javascript">
      Bokeh.set_log_level("info");
    </script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- pyscript-->
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script> 
    <!-- python libraries-->
<py-env>
    - pandas
    - matplotlib
    - folium
    - panel==0.13.1a2
</py-env>
</head>

<body>
<div class="w3-sidebar w3-light-grey w3-bar-block" style="width:17%">
<div id="fileinput"></div>
<div id="upload"></div>

<div id="generatedefaultmap"></div>

<div id="selectperiod"></div>
<div id="selectduration"></div>
<div id="generatedefaultmapwithtimeslider"></div>

<div id="columns"></div>
<div id="lat"></div>
<div id="lon"></div>
<div id="altitude"></div>
<div id="errortext"></div>
<div id="generatecustomizedmap"></div>

<div id="min"></div>
<div id="max"></div>
<div id="generatetimestampmap"></div>

<div id="generateplots"></div>
</div>
<div style="margin-left:18%">
    <div id="table"></div>
    <div id="folium" style="width: 1000px; height: 800px"></div>
    <div id="folium1" style="width: 1000px; height: 800px"></div>
    <div id="folium2" style="width: 1000px; height: 800px"></div>
    <div id="folium3" style="width: 1000px; height: 800px"></div>
    <div id="folium4" style="width: 1000px; height: 800px"></div>
    <div id="s11"></div>
    <div id="s1"></div>

    <div id="s21"></div>
    <div id="s2"></div>

    <div id="s31"></div>
    <div id="s3"></div>

    <div id="s41"></div>
    <div id="s4"></div>

    <div id="plt1"></div>
    <div id="plt2"></div>
    <div id="plt3"></div>
</div>
<py-script>
#panel ui
import asyncio
import panel as pn
from panel.io.pyodide import show
#temporary
import js
from js import document, FileReader
#main
from pyodide import create_proxy
import pandas as pd
#read_complete
from io import StringIO
#plots
import numpy as np
from matplotlib import pyplot as plt
from matplotlib import style
style.use('ggplot')
import matplotlib.gridspec as gridspec
import calendar
#folium map
import folium
from folium import plugins
import random
import datetime
#color scale (generate_speed_map)
import branca.colormap as cmp


#creating the ui components

#input and upload section
fileInput = pn.widgets.FileInput(accept='.csv')
uploadButton = pn.widgets.Button(name='Upload CSV File', button_type = 'primary')

table = pn.widgets.Tabulator(pagination='remote', page_size=10)
document.getElementById('table').style.display = 'none'

#default map section
generateDefaultMap = pn.widgets.Button(name='Generate Default Map', button_type='primary')

#timeslider map section
selectPeriod = pn.widgets.Select(name='Select period', options=['P1M', 'P1D', 'PT1H', 'PT1M'])
selectDuration = pn.widgets.Select(name='Select duration', options=['P1M', 'P1D', 'PT1H', 'PT1M'])

generateDefaultMapWithTimeslider = pn.widgets.Button(name='Generate Default Map With Timeslider', button_type='primary')

#customized map section
ColumnText = pn.pane.Markdown('Columns (Required*)')
LatSelect = pn.widgets.Select(name='Lat*', options=[])
LonSelect = pn.widgets.Select(name='Lon*', options=[])
AltitudeSelect = pn.widgets.Select(name='Altitude', options=[])
ErrorText = pn.widgets.StaticText(name='', value='')
generateCustomizedMap = pn.widgets.Button(name='Generate Customized Map', button_type='primary')

#range timestamp section
MinTimestamp = pn.widgets.TextInput(name='Min Timestamp', placeholder='Enter a min timestamp here...')
MaxTimestamp = pn.widgets.TextInput(name='Max Timestamp', placeholder='Enter a max timestamp here...')
generateTimestampMap = pn.widgets.Button(name='Generate Map of a Timestamp Range', button_type='primary')

#plots section
generatePlots = pn.widgets.Button(name='Generate Statistics & Plots', button_type='primary')


df = pd.DataFrame() 
#trajectory df keeps track of the trajectory colors of every object
trajectories_df = pd.DataFrame(columns=['oid', 'color'])


def init_map():
    #initialize the folium map
    m = folium.Map(zoom_start=12)

    #different styles of map are available with a layer control
    folium.TileLayer('openstreetmap').add_to(m)
    folium.TileLayer('cartodbdark_matter').add_to(m)
    folium.TileLayer('cartodbpositron').add_to(m)
    folium.TileLayer('stamenwatercolor').add_to(m)
    folium.TileLayer('stamentoner').add_to(m)

    folium.LayerControl().add_to(m)

    return m


def process_file(event):
    #read uploaded csv file and display it into a table
    if fileInput.value is not None:
        table.value = pd.read_csv(io.BytesIO(fileInput.value))
        global df
        df = table.value 
        #process data
        if 'mmsi' in df.columns:
            df = df.rename(columns={'mmsi': 'oid'})
        elif 'id' in df.columns:
            df = df.rename(columns={'id': 'oid'})

        document.getElementById('table').style.display = 'block'

    #fill the dropdowns with the specific column names
    LatSelect.options = list(df.columns)
    LonSelect.options = list(df.columns)
    AltitudeSelect.options = list(df.columns)

   

def plots(event):
    #number of vessels
    pyscript.write('s11', 'Number of records: ')
    pyscript.write('s1', len(df['oid'].unique()))
    
    #number of records (signals) per day
    pyscript.write('s21', 'Number of records (signals) per day: ')
    pyscript.write('s2', df.groupby([pd.to_datetime(df.t, unit='ms').dt.date]).apply(len))
    
    #number of records(signals) per vessel
    pyscript.write('s31', 'Number of records(signals) per object: ')
    pyscript.write('s3', df.groupby('oid').apply(len))

    #average number of records (signals) per vessel daily
    df.groupby(['oid', pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)
    average = df.groupby(['oid', pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)

    pyscript.write('s41', 'Average number of records (signals) per vessel daily: ')
    pyscript.write('s4', average.groupby('oid').apply(lambda x: x.mean()))
    
    #plots
    #distribution of number of records (signals) per vessel
    num_of_rec_per_v = df.groupby('oid').apply(len)
    out = pd.cut(num_of_rec_per_v, bins=10)
    ax = out.value_counts(sort=False).plot.bar(figsize=(6,6), fontsize=8, width=0.75, cmap='tab20c', rot=40)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Distribution of the number of signals per vessel', fontsize=8, y=1)
    plt.xlabel('number of signals', fontsize=8)
    plt.ylabel('number of vessels', fontsize=8)
    pyscript.write('plt1', plt)

    #distribution of number of records per vessel daily
    num_of_rec_per_v_d = df.groupby([df.oid, pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)
    num_of_rec_per_v_d = num_of_rec_per_v_d.groupby('oid').apply(lambda x: x.mean())
    out = pd.cut(num_of_rec_per_v_d, bins=10)
    ax = out.value_counts(sort=False).plot.bar(figsize=(6,6), fontsize=8, width=0.75, cmap='tab20c', rot=40)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Distribution of the number of signals per vessel daily', fontsize=8, y=1)
    plt.xlabel('number of signals', fontsize=8)
    plt.ylabel('number of vessels', fontsize=8)
    pyscript.write('plt2', plt)

    #distribution of number of records (signals) per weekday
    num_of_rec_per_day = df.groupby([pd.to_datetime(df.t, unit='ms').dt.date]).apply(len).to_frame().reset_index()
    num_of_rec_per_day.loc[:, 'day_name'] = pd.to_datetime(num_of_rec_per_day.t).dt.day_name()
    num_of_rec_per_day.loc[:, 'day_name']= pd.Categorical(num_of_rec_per_day.day_name, categories=list(calendar.day_name), ordered=True)
    num_of_rec_per_day.sort_values('day_name', inplace=True)
    num_of_rec_per_day.plot.bar(x='day_name', figsize=(6,6), fontsize=8, width=0.75, legend=False, cmap='tab20c', rot=30)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Distribution of number of records (signals) per weekday:')
    plt.xlabel(r'',fontsize=8)
    plt.ylabel(r'number of records', fontsize=8)
    pyscript.write('plt3', plt)


def trajectories():
    color_list = ['red', 'blue', 'green', 'purple', 'orange', 'darkred',
                 'lightred', 'beige', 'darkblue', 'darkgreen', 'cadetblue',
                 'darkpurple', 'white', 'pink', 'lightgreen',
                 'gray', 'black', 'lightgray']

    for i in range(0, len(df)):           
        if df.iloc[i]['oid'] not in trajectories_df.values:
            trajectory_color = random.choice(color_list)
            trajectories_df.loc[len(trajectories_df.index)] = [df.iloc[i]['oid'], trajectory_color]
        elif df.iloc[i]['oid'] in trajectories_df.values:
            trajectory_color = trajectories_df['color'].where(trajectories_df['oid'] == df.iloc[i]['oid']).values
   
    return trajectories_df


def speed_mean():
    sum_speed=0
    #for every record that the speed isn't 0
    for i in range(0, len(df)):
        if df.iloc[i]['speed'] !=0:
            sum_speed = sum_speed + df.iloc[i]['speed'].astype(int)

    mean_speed = sum_speed / len(df)

    return mean_speed


def generate_timestamp_map(event):
    m = init_map()
    #bouding box
    m.fit_bounds([[df['lat'].min(), df['lon'].min()], [df['lat'].max(), df['lon'].max()]])
   
    min_input= MinTimestamp.value
    max_input= MaxTimestamp.value

    inside_range=False

    #plotting markers on the map
    for i in range(0, len(df)):
        
        if df.iloc[i]['t'].astype(str) in min_input or inside_range == True:
            inside_range=True
            x = df.iloc[i]['oid'].astype(int)
            folium.CircleMarker(location=[df.iloc[i]['lat'], df.iloc[i]['lon']],
                                radius=2, weight=5,
                                color='blue', popup=df.iloc[i]['oid']).add_to(m)
            if df.iloc[i]['t'].astype(str) in max_input:
                inside_range=False
    
    pyscript.write('folium4', m)
   

def generate_default_map(event):
    m = init_map()
    #default map: blue points only based on lon, lat
    m.fit_bounds([[df['lat'].min(), df['lon'].min()], [df['lat'].max(), df['lon'].max()]])
    
    #plotting markers on the map
    for i in range(0, len(df)):
        folium.CircleMarker(location=[df.iloc[i]['lat'], df.iloc[i]['lon']],
                            radius=2, weight=5,
                            color='blue', popup=df.iloc[i]['oid']).add_to(m)

    pyscript.write('folium', m)


def generate_default_map_with_timeslider(event):
    m = init_map()
    #default map with timeslider: blue points only based on lon, lat with timeslider based on timestamps

    m.fit_bounds([[df['lat'].min(), df['lon'].min()], [df['lat'].max(), df['lon'].max()]])

    #create the features input for the TimestampedGeoJson
    features = []

    extra_seconds = 0

    for i in range(0, len(df)):

        time_stamp = str(pd.to_datetime(df.iloc[0]['t'], unit='ms') + datetime.timedelta(0, 60*extra_seconds)).split('.')[0]
        feature = {
            'type': 'Feature',
            'geometry': {
                'type': 'Point',
                'coordinates': [float(df.iloc[i]['lon']), float(df.iloc[i]['lat'])]
            },
            'properties': {
                'time': time_stamp,
                'style': {'color': ''},
                'icon': 'circle',
                'iconstyle': {
                    'fillColor': '#0000FF',
                    'fillOpacity': 0.8,
                    'stroke': 'true',
                    'radius': 5
                }
            }
        }
        features.append(feature)
        extra_seconds += 1
    
    #period (str, default "P1D") – Used to construct the array of available times starting from the first available time.
    #Format: ISO8601 Duration ex: ‘P1M’ 1/month, ‘P1D’ 1/day, ‘PT1H’ 1/hour, and ‘PT1M’ 1/minute

    #duration (str, default None) – Period of time which the features will be shown on the map after their time has passed.
    #If None, all previous times will be shown.
    #Format: ISO8601 Duration ex: ‘P1M’ 1/month, ‘P1D’ 1/day, ‘PT1H’ 1/hour, and ‘PT1M’ 1/minute

    #default - better results:
    #period='PT1H'
    #duration='P1M'
    
    plugins.TimestampedGeoJson(features,
                       period=selectPeriod.value,
                       duration=selectDuration.value,
                       transition_time=1000,
                       auto_play=True).add_to(m)

    pyscript.write('folium1', m)


def generate_trajectories_map():
    m = init_map()
    #trajectories map: colorful points based on trajectories

    if trajectories_df.empty:
        #calling trajectories function for color initialization
        traj_df = trajectories()
        #bounding box
        m.fit_bounds([[df['lat'].min(), df['lon'].min()], [df['lat'].max(), df['lon'].max()]])
    else:
        traj_df = trajectories_df

    #plotting markers on the map
    for i in range(0, len(df)):
        x = df.iloc[i]['oid'].astype(int)
        traj_color = traj_df.iloc[x]['color']

        folium.CircleMarker(location=[df.iloc[i]['lat'], df.iloc[i]['lon']],
                            radius=2, weight=5,
                            color=traj_color, popup=df.iloc[i]['oid']).add_to(m)
    
    pyscript.write('folium2', m)


def generate_speed_map():
    m = init_map()
    #speed map: different sized points based on mean speed

    m.fit_bounds([[df['lat'].min(), df['lon'].min()], [df['lat'].max(), df['lon'].max()]])
    mean_s = speed_mean()
    #max_seepd = df.loc[df['speed'].idxmax()].astype(int)

    #define the color scale
    color_scale = cmp.StepColormap(
        ['red', 'orange', 'green'],
        vmin=0.0, vmax=100,
        index=[0.0, 1, mean_s, 100],  
        caption='Color Scale for Speed'    
    )

    #plotting markers on the map
    for i in range(0, len(df)):
        speed_color = 'orange'

        if df.iloc[i]['speed'].astype(int) > mean_s:
            speed_color = 'green'
        elif df.iloc[i]['speed'].astype(int) == 0:
            speed_color = 'red'

        folium.CircleMarker(location=[df.iloc[i]['lat'], df.iloc[i]['lon']],
                            radius=2, weight=5,
                            color= speed_color, popup=df.iloc[i]['speed']).add_to(m)
    
    #add color scale to map
    color_scale.add_to(m)

    pyscript.write('folium3', m)


def map_options(event):
    if LatSelect.value == 'lat' and LonSelect.value == 'lon' and AltitudeSelect.value == 'speed':
        generate_speed_map()
    elif LatSelect.value == 'lat' and LonSelect.value == 'lon' and AltitudeSelect.value == 'oid':
        generate_trajectories_map()
    else:
        ErrorText.value = 'Error: Cannot show map results with specific columns!'
        

def main():
    uploadButton.on_click(process_file)
    generateDefaultMap.on_click(generate_default_map) 
    generatePlots.on_click(plots)
    generateDefaultMapWithTimeslider.on_click(generate_default_map_with_timeslider)
    generateCustomizedMap.on_click(map_options)
    generateTimestampMap.on_click(generate_timestamp_map)

main()

#display the ui components on web
await show(fileInput, 'fileinput')
await show(uploadButton, 'upload')
await show(generateDefaultMap, 'generatedefaultmap')
await show(table, 'table')
await show(generatePlots, 'generateplots')
await show(selectPeriod, 'selectperiod')
await show(selectDuration, 'selectduration')
await show(generateDefaultMapWithTimeslider, 'generatedefaultmapwithtimeslider')
await show(LatSelect, 'lat')
await show(LonSelect, 'lon')
await show(AltitudeSelect, 'altitude')
await show(ColumnText, 'columns')
await show(ErrorText, 'errortext')
await show(generateCustomizedMap, 'generatecustomizedmap')
await show(MinTimestamp, 'min')
await show(MaxTimestamp, 'max')
await show(generateTimestampMap, 'generatetimestampmap')
    </py-script>
</body>
