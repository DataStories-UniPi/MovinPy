<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Analytics</title>
    <link rel="stylesheet" href="/static/css/visuals.css">
    <!-- papa parse-->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- jquery-->
    <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
    <!-- css for leaflet map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <!-- javascript file for leaflet map -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <!-- pyscript-->
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script> 
    <!-- map height -->
    <style>
       #leaflet_map{ height: 800px;}
    </style>
    <!-- python libraries-->
<py-env>
    - pandas
    - matplotlib
</py-env>
</head>
<body>
   <!-- navigation bar --> 
    <nav class='nav'>
        <form>
        <input class='nav__link' type="file" id="csvfile" name="csvfile" accept=".csv">
        </form>
        <a href='/map' class='nav__link' data-link>Map</a>
        <a href='/plots' class='nav__link' data-link>Plots</a>
        <a href='/repl' class='nav__link' data-link>Interactive REPL</a>
    </nav>
    <div id="app"></div>
    <script type='module' src='static/js/visuals.js'></script>
    <py-script>
import asyncio
import js
from js import document, FileReader
from pyodide import create_proxy
import pandas as pd
from io import StringIO
import numpy as np
from matplotlib import pyplot as plt
from matplotlib import style
style.use('ggplot')
import matplotlib.gridspec as gridspec
import calendar

def read_complete(event):
    #event is ProgressEvent
    output = document.getElementById("output")
    #output.innerText = event.target.result

    #basic statistics
    csv = StringIO(event.target.result)
    df = pd.read_csv(csv)
    
    #number of vessels
    pyscript.write('s1', len(df['oid'].unique()))
    
    # number of records (signals) per day
    pyscript.write('s2', df.groupby([pd.to_datetime(df.t, unit='ms').dt.date]).apply(len))
    
    #number of records(signals) per vessel
    pyscript.write('s3', df.groupby('oid').apply(len))

    # average number of records (signals) per vessel daily
    df.groupby(['oid', pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)
    average = df.groupby(['oid', pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)
    pyscript.write('s4', average.groupby('oid').apply(lambda x: x.mean()))
    
    #plots
    # distribution of number of records (signals) per vessel
    num_of_rec_per_v = df.groupby('oid').apply(len)
    out = pd.cut(num_of_rec_per_v, bins=10)
    ax = out.value_counts(sort=False).plot.bar(figsize=(10,6), fontsize=8, width=0.75, cmap='Pastel1', rot=40)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Distribution of the number of signals per vessel', fontsize=8, y=1)
    plt.xlabel('number of signals', fontsize=8)
    plt.ylabel('number of vessels', fontsize=8)
    pyscript.write('plt1', plt)

    # distribution of number of records per vessel daily
    num_of_rec_per_v_d = df.groupby([df.oid, pd.to_datetime(df.t, unit='ms').dt.date]).apply(len)
    num_of_rec_per_v_d = num_of_rec_per_v_d.groupby('oid').apply(lambda x: x.mean())
    out = pd.cut(num_of_rec_per_v_d, bins=10)
    ax = out.value_counts(sort=False).plot.bar(figsize=(10,6), fontsize=8, width=0.75, cmap='Pastel1', rot=40)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Distribution of the number of signals per vessel daily', fontsize=8, y=1)
    plt.xlabel('number of signals', fontsize=8)
    plt.ylabel('number of vessels', fontsize=8)
    pyscript.write('plt2', plt)

    # distribution of number of records (signals) per weekday
    num_of_rec_per_day = df.groupby([pd.to_datetime(df.t, unit='ms').dt.date]).apply(len).to_frame().reset_index()
    num_of_rec_per_day.loc[:, 'day_name'] = pd.to_datetime(num_of_rec_per_day.t).dt.day_name()
    num_of_rec_per_day.loc[:, 'day_name']= pd.Categorical(num_of_rec_per_day.day_name, categories=list(calendar.day_name), ordered=True)
    num_of_rec_per_day.sort_values('day_name', inplace=True)
    num_of_rec_per_day.plot.bar(x='day_name', figsize=(10,6), fontsize=8, width=0.75, legend=False, cmap='Pastel1', rot=30)
    plt.ticklabel_format(style='sci', axis='y', scilimits=(0,0))
    plt.suptitle('Records per weekday')
    plt.xlabel(r'',fontsize=8)
    plt.ylabel(r'number of records', fontsize=8)
    pyscript.write('plt3', plt)


async def process_file(x):
    fileList = document.getElementById('csvfile').files
    
    for f in fileList:
        #reader is a pyodide.JsProxy
        reader = FileReader.new()

        #create a python proxy for the callback function
        onload_event = create_proxy(read_complete)

        reader.onload = onload_event

        reader.readAsText(f)
        
def main():
    #create a python proxy for the callback function
    file_event = create_proxy(process_file)
    #set the listener to the callback
    e = document.getElementById("csvfile")
    e.addEventListener("change", file_event, False)
    

main()
    </py-script>
</body>
</html>